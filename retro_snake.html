<html>
  <head>
    <title>Retro Snake</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  </head>
  <body>
    <!-- <h3>Retro Snake</h3> -->

    <canvas width="500" class="w3-center" height="500" id="ctx" style="border:2px solid #32CD32">Your browser does not support the HTML5 canvas tag. </canvas> </br>
    <div class="w3-panel w3-pink"> 
      <h4 id="score" class="w3-text-white"></h4>
      <button id="up" class="w3-button w3-teal w3-round-xxlarge gamepadOnOff" onclick="activateGamepad(event)">Activate Gamepad</button></br></br>
      <div id="gamepad"></div>
    </div>
    <!-- background music -->
        <audio id="audio" loop>
          <source src="./audio/contra1.mp3" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
    
    
    <!-- GAME -->
    <script type="text/javascript">

      var ctx = document.getElementById('ctx').getContext('2d');

      var WIDTH = 500;
      var HEIGHT = 500;
      var snakeList, foodList, direction, eaten, intervalVar, running = false;
      let score = 0;
      const audio = document.getElementById("audio")
      ctx.font = '20px Calibri';


      const snakeBody = {
        height:20,
        width:20,
        color: 'violet'
      }

      const food = {
        height:20,
        width:20,
        color: 'lime'
      }

      const activateGamepad = function(event) {
        const gamepad = document.getElementById("gamepad")
        const gamepadOnOff = document.querySelector(".gamepadOnOff")
        if (gamepadOnOff.classList.contains('on')) {
          gamepadOnOff.textContent = "Activate Gamepad"
          gamepad.innerHTML = ""
          gamepadOnOff.classList.remove('on')
        } else {
          gamepad.innerHTML = 
          `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <button id="up" class="w3-button w3-indigo w3-round-xxxlarge" onclick="mangeKeyBtnPressed(event)">↑</button></br></br> 
          <button id="left" class="w3-button w3-purple w3-round-xxxlarge" onclick="mangeKeyBtnPressed(event)">←</button>&nbsp;&nbsp;
          <button id="right" class="w3-button w3-purple w3-round-xxxlarge"  onclick="mangeKeyBtnPressed(event)">→</button></br> </br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button id="down" class="w3-button w3-indigo w3-round-xxxlarge" onclick="mangeKeyBtnPressed(event)">↓</button></br>`
          gamepadOnOff.classList.add('on')
          gamepadOnOff.textContent = "Deactivate Gamepad"

        }
      }

      const mangeKeyBtnPressed = function(event) {
        //0 - Left
        //1 - Up
        //2 - Right
        //3 - Down
        document.getElementById("audio").play()
        // console.log(event.target.id, event.keyCode)
        if ((event.keyCode == 37 || event.target.id == "left") && direction != 2) {
          direction = 0;
        }
        else if ((event.keyCode == 38 || event.target.id == "up" ) && direction != 3) {
          direction = 1;
        }
        else if ((event.keyCode == 39 || event.target.id == "right") && direction != 0) {
          direction = 2;
        }
        else if ((event.keyCode == 40 || event.target.id == "down") && direction != 1) {
          direction = 3;
        }
      } 


      //track left,up, right, down arrows pressed
      document.onkeydown = mangeKeyBtnPressed

      //first head list moves position and other ones take position of one in front
      const updateSnakeList = function() {
          for (let i = snakeList.length - 1; i >=0; i--) {
              if (direction == 0) {
                  if(i == 0) {
                      snakeList[i].x = snakeList[i].x - 5
                  } else {
                    snakeList[i].x = snakeList[i - 1].x
                    snakeList[i].y = snakeList[i - 1].y

                  }

              }
              else if (direction == 1) {
                  if(i == 0) {
                      snakeList[i].y = snakeList[i].y - 5
                  } else {
                    snakeList[i].x = snakeList[i - 1].x
                    snakeList[i].y = snakeList[i - 1].y

                  }
              }
              else if (direction == 2) {
                  if(i == 0) {
                      snakeList[i].x = snakeList[i].x + 5
                  } else {
                    snakeList[i].x = snakeList[i - 1].x
                    snakeList[i].y = snakeList[i - 1].y

                  }
              }
              else if (direction == 3) {
                  if(i == 0) {
                      snakeList[i].y = snakeList[i].y + 5
                  } else {
                    snakeList[i].x = snakeList[i - 1].x
                    snakeList[i].y = snakeList[i - 1].y

                  }
              }              

          }
      }
      //test collisions on two . Below we test with snake as rect1 and food as rect2
      const testCollision = function(rect1,rect2) {
        return ((rect1.x <= rect2.x + food.width) &&
                (rect2.x <= rect1.x + snakeBody.width) &&
                (rect1.y <= rect2.y + food.height) &&
                (rect2.y <= rect1.y + snakeBody.height));
      }

      const testCollisionGameOver = function(snake1, snake2) {
        // the 5 can be changed to 10. This is like the difficulty level parameter.
        return ((Math.abs(snake1.x - snake2.x) < 5) &&
                (Math.abs(snake1.y - snake2.y) < 5));
      }

      const isGameOver = function() {
        for (i in snakeList) {
          //snake head will always collide with itself so we will not check that.
          if (i == 0) continue;
          if (testCollisionGameOver(snakeList[0], snakeList[i])) {
              ctx.save()
              ctx.fillStyle = "lime";  
              ctx.fillText('Game Over! Refresh or click to restart',150,250);
              ctx.restore()
              clearInterval(intervalVar);
              return;
          }
        }
      }

      const drawSnake = (sb,idx) => {
        ctx.save()

        if (idx == 0) { //identify head of snake
            ctx.fillStyle = 'grey'
            ctx.fillRect(sb.x,sb.y, snakeBody.width, snakeBody.height)
            ctx.restore()
        } else {
            ctx.fillStyle = snakeBody.color
            ctx.fillRect(sb.x,sb.y, snakeBody.width, snakeBody.height)
    
            ctx.restore()

        }

      }

      const drawFood = (f,idx) => {
        ctx.save()
        if (!running) {
          ctx.fillStyle = "lime";  
          ctx.fillText('Welcome! To start, move keyboard arrows or use gamepad.',5,15);

        }
        ctx.fillStyle = food.color

        ctx.fillRect(f.x, f.y, food.width, food.height)

        ctx.restore()
      }

      //function responsible for drawing everything in canvas
      const updateSnakePosition = function() {
        //clear canvas
        // ctx.clearRect(0,0, WIDTH, HEIGHT);

        // clear and make background black:
        ctx.fillRect(0,0, WIDTH, HEIGHT);

        // draw food
        while(eaten) {
          var pos_x = Math.random()*485+5;
          var pos_y = Math.random()*485+5;
          foodList[0] = {x:pos_x,y:pos_y};
          eaten = false;
        }
        //shortcut to call it
        foodList.forEach(drawFood);

        //draw snake and update snake.
        snakeList.map((snake, i) => {
              drawSnake(snake, i)
        })
        updateSnakeList()
        checkSnakePosition()
        isGameOver()
        // ctx.fillStyle = "white"
        document.getElementById("score").innerText = `Score: ${score}`
        // ctx.fillText(`Score: ${score}`, 400, 30)
        
        if(testCollision(snakeList[0], foodList[0])) {
          //if collision in snake head and food increase score
          score += 1

          foodList = [];
          eaten = true;
          running = true;
          var newX, newY;
          // determine which direction snake is going while eating food then add food to the head of the snake as new head
          if (direction == 0) {
            newX = snakeList[0].x - 10
            newY = snakeList[0].y
          }
          else if (direction == 1) {
            newX = snakeList[0].x
            newY = snakeList[0].y - 10
          }
          else if (direction == 2) {
            newX = snakeList[0].x + 10
            newY = snakeList[0].y
          }
          else if (direction == 3) {
            newX = snakeList[0].x
            newY = snakeList[0].y + 10
          }
          snakeList.unshift({
            x: newX,
            y: newY,
          })
        }
      }

      //take care of boundary condition
      const checkSnakePosition =  function() { 
        // check head of snake if goes farther than size of canvas
        if (snakeList[0].x > 500) {
            snakeList[0].x = 0
        }
        else if (snakeList[0].x < 0) {
            snakeList[0].x = 500
        }
        else if (snakeList[0].y > 500) {
            snakeList[0].y = 0
        }
        else if (snakeList[0].y < 0) {
            snakeList[0].y = 500
        }
      }


      const startGame = function() {
          snakeList = [
              {x: 220, y: 200}, //snake head
              {x: 210, y: 200},
              {x: 200, y: 200}
          ];
          foodList = [];

          direction = 99;
          eaten = true;
          //updateSnakePosition will be called every second and fresh snake will be drawn.
          //by adding to a variable it returns an integer that we can then stop.
          intervalVar = setInterval(updateSnakePosition, 25)
      }

      document.getElementById('ctx').onmousedown = function() {
        if (running) {
          clearInterval(intervalVar);
          running = false
          audio.pause()
          audio.currentTime = 0
        }
        score = 0
        clearInterval(intervalVar);
        startGame();
      }

      //start the game
      startGame();
      

    </script>
  </body>
</html>
